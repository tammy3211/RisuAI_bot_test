<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RisuAI Character Tester (Svelte)</title>
</head>
<body>
    <div id="app"></div>
    <script type="module" src="./main.ts"></script>
</body>
</html>


        <!-- Chat Test Tab -->
        <div id="chat-tab" class="tab-content">
            <div class="info-panel">
                <h4>💬 채팅 테스트</h4>
                <ul>
                    <li>로어북, CBS, Regex 등이 실제 채팅에서 어떻게 작동하는지 테스트합니다</li>
                    <li>User 또는 Assistant 역할을 선택해서 메시지를 추가할 수 있습니다</li>
                    <li>로어북 항목이 자동으로 삽입되는지 확인할 수 있습니다</li>
                </ul>
            </div>

            <div class="section">
                <div class="section-title">💬 채팅 내역</div>
                <div id="chat-messages" class="chat-messages">
                    <div class="chat-message system">
                        <div class="message-role">System</div>
                        <div class="message-content">채팅 테스트를 시작합니다. 메시지를 추가해보세요!</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">메시지 작성</div>
                <div class="grid">
                    <div>
                        <div class="input-group">
                            <label class="label">역할 (Role):</label>
                            <select id="chat-role" class="role-select">
                                <option value="user">User (사용자)</option>
                                <option value="assistant">Assistant (AI/캐릭터)</option>
                                <option value="system">System (시스템)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="input-group">
                            <label class="label">옵션:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="apply-regex" checked> Regex 적용</label>
                                <label><input type="checkbox" id="apply-cbs" checked> CBS 처리</label>
                                <label><input type="checkbox" id="show-lorebook" checked> 로어북 표시</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="label">메시지 내용:</label>
                    <textarea id="chat-input" placeholder="메시지를 입력하세요..."></textarea>
                </div>

                <div class="toolbar">
                    <button id="send-message" class="btn">📤 메시지 추가</button>
                    <button id="clear-chat" class="btn btn-secondary">🗑️ 대화 초기화</button>
                    <button id="export-chat" class="btn btn-success">💾 대화 내보내기</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">활성화된 로어북 항목</div>
                <div id="active-lorebook" class="lorebook-active-list">
                    <p class="help-text">메시지를 추가하면 활성화된 로어북 항목이 여기 표시됩니다.</p>
                </div>
            </div>
        </div>

        <!-- Lorebook Tab -->
        <div id="lorebook-tab" class="tab-content hidden">
            <div class="info-panel">
                <h4>📚 Lorebook 관리</h4>
                <ul>
                    <li>JSON 파일로 메타데이터를 관리하고, MD 파일로 실제 내용을 작성합니다</li>
                    <li>각 로어북 항목은 별도의 MD 파일로 관리되어 버전 관리가 쉽습니다</li>
                    <li><code>lorebook.json</code>에서 키워드, 우선순위 등을 설정합니다</li>
                </ul>
            </div>

            <div class="section">
                <div class="section-title">로어북 항목 목록</div>
                <div class="toolbar">
                    <button id="reload-lorebook" class="btn">🔄 새로고침</button>
                    <button id="export-lorebook" class="btn btn-success">📥 전체 내보내기</button>
                </div>
                
                <div id="lorebook-list" class="lorebook-container">
                    <p class="loading-text">로딩 중...</p>
                </div>
            </div>

            <div class="example-box">
                <h4>💡 파일 구조</h4>
                <p><strong>lorebook.json:</strong></p>
                <pre><code>{
  "key": "세계, 세계관, world",
  "comment": "세계관 설정",
  "content": "{world_setting}",
  "secondkey": "세계관 상세, 설정",
  ...
}</code></pre>
                <p><strong>world_setting.md:</strong> 실제 로어북 내용</p>
                <p>JSON의 <code>content</code> 필드의 <code>{world_setting}</code>이 MD 파일 내용으로 대체됩니다.</p>
            </div>
        </div>

        <!-- Regex Tab -->
        <div id="regex-tab" class="tab-content hidden">
            <div class="info-panel">
                <h4>🔧 Regex Trigger 관리</h4>
                <ul>
                    <li>정규표현식을 사용하여 텍스트를 자동으로 변환합니다</li>
                    <li>입력 전처리(editinput) 또는 출력 후처리(editoutput)에 사용됩니다</li>
                    <li>MD 파일에 실제 교체 내용을 저장합니다</li>
                </ul>
            </div>

            <div class="section">
                <div class="section-title">Regex 목록</div>
                <div class="toolbar">
                    <button id="reload-regex" class="btn">🔄 새로고침</button>
                    <button id="export-regex" class="btn btn-success">📥 목록 내보내기</button>
                </div>
                
                <div id="regex-list" class="regex-container">
                    <p class="loading-text">로딩 중...</p>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Regex 테스트</div>
                <div class="grid">
                    <div>
                        <div class="input-group">
                            <label class="label">패턴 (Pattern):</label>
                            <input type="text" id="regex-pattern" placeholder="\b(\w+)\b">
                        </div>
                        
                        <div class="input-group">
                            <label class="label">교체 문자열 (Replacement):</label>
                            <input type="text" id="regex-replacement" placeholder="$1">
                        </div>
                    </div>

                    <div>
                        <div class="input-group">
                            <label class="label">테스트 텍스트:</label>
                            <textarea id="regex-test-text" placeholder="테스트할 텍스트 입력"></textarea>
                        </div>
                        
                        <button id="test-regex" class="btn">🧪 테스트</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="label">결과:</label>
                    <textarea id="regex-output" readonly></textarea>
                </div>
            </div>
        </div>

        <!-- CBS Tab -->
        <div id="cbs-tab" class="tab-content hidden">
            <div class="info-panel">
                <h4>📝 CBS (ChatBot Script)</h4>
                <ul>
                    <li>RisuAI의 템플릿 언어로, 동적 텍스트 생성을 가능하게 합니다</li>
                    <li>변수, 조건문, 함수 등을 사용할 수 있습니다</li>
                    <li>예: <code>{{user}}</code>, <code>{{char}}</code>, <code>{{time}}</code></li>
                    <li>실제 RisuAI의 CBS 파서를 사용하여 테스트합니다</li>
                </ul>
            </div>

            <div class="section">
                <div class="section-title">테스트 환경 설정</div>
                <div class="grid">
                    <div>
                        <div class="input-group">
                            <label class="label">사용자 이름 (Username):</label>
                            <input type="text" id="test-username" value="TestUser" placeholder="사용자 이름">
                        </div>
                    </div>
                    <div>
                        <div class="input-group">
                            <label class="label">캐릭터 이름 (Character):</label>
                            <input type="text" id="test-charname" value="TestBot" placeholder="캐릭터 이름">
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">페르소나 (Persona):</label>
                    <textarea id="test-persona" placeholder="페르소나 설명">I am a helpful assistant</textarea>
                </div>
            </div>

            <div class="section">
                <div class="section-title">CBS 테스트</div>
                <div class="input-group">
                    <label class="label">테스트할 텍스트:</label>
                    <textarea id="cbs-test-text" placeholder="Hello {{user}}, I'm {{char}}. Today is {{date}} at {{time}}!">Hello {{user}}, I'm {{char}}. Today is {{date}} at {{time}}!</textarea>
                </div>
                
                <div class="toolbar">
                    <button id="test-cbs" class="btn">🧪 테스트 실행</button>
                    <button id="clear-cbs" class="btn btn-secondary">🗑️ 초기화</button>
                </div>

                <div class="input-group">
                    <label class="label">결과:</label>
                    <textarea id="cbs-output" readonly></textarea>
                </div>
            </div>

            <div class="example-box">
                <h4>💡 CBS 예제</h4>
                <p><strong>기본 변수:</strong> <code>{{user}}</code>, <code>{{char}}</code>, <code>{{time}}</code>, <code>{{date}}</code>, <code>{{random}}</code></p>
                <p><strong>예제:</strong></p>
                <pre>안녕하세요 {{user}}님! 저는 {{char}}입니다.
현재 시간은 {{time}}이고, 오늘 날짜는 {{date}}입니다.
난수: {{random}}</pre>
            </div>
        </div>

        <!-- Lua Tab -->
        <div id="lua-tab" class="tab-content hidden">
            <div class="info-panel">
                <h4>🌙 Lua Script</h4>
                <ul>
                    <li>강력한 스크립팅 언어로 복잡한 로직 구현 가능</li>
                    <li>RisuAI에서 트리거, 버튼 등에 사용됩니다</li>
                    <li>실제 실행은 RisuAI 앱 내에서만 가능합니다</li>
                </ul>
            </div>

            <div class="section">
                <div class="section-title">Lua 스크립트 보기</div>
                <div class="input-group">
                    <label class="label">Lua 코드:</label>
                    <textarea id="lua-input" class="code-area" readonly placeholder="Lua 스크립트는 RisuAI에서 직접 편집하세요"></textarea>
                </div>
                <p class="help-text">Lua 스크립트 실행은 RisuAI 앱에서만 가능합니다</p>
            </div>
        </div>
    </div>

    <!-- MD Viewer Modal -->
    <div id="md-viewer-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="md-viewer-title">문서</h2>
                <button id="close-modal" class="close-btn">닫기</button>
            </div>
            <div id="md-viewer-content"></div>
        </div>
    </div>

    <!-- Emergency tab switching fallback -->
    <script>
        // Immediate tab switching setup (before modules load)
        console.log('🔧 Setting up emergency tab handlers...');
        
        function switchTabImmediate(tabName) {
            console.log('🔄 Emergency switch to:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                console.log('✅ Tab shown:', tabName);
            } else {
                console.error('❌ Tab not found:', tabName);
            }
            
            // Update button states
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector('[data-tab="' + tabName + '"]');
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        // Setup immediately when DOM loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEmergencyTabs);
        } else {
            setupEmergencyTabs();
        }
        
        function setupEmergencyTabs() {
            console.log('🔧 Setting up emergency tab listeners...');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const tab = this.getAttribute('data-tab');
                    console.log('📍 Emergency tab clicked:', tab);
                    if (tab) {
                        switchTabImmediate(tab);
                    }
                });
            });
            console.log('✅ Emergency tab listeners ready');
        }
    </script>

    <script type="module" src="./preload.ts"></script>
</body>
</html>
